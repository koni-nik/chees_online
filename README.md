# Шахматы Онлайн

Веб-приложение для игры в шахматы онлайн с поддержкой мультиплеера.

## Архитектура

### Структура проекта
```
chess-online/
├── backend/           # Backend сервер (FastAPI)
│   ├── main.py       # Основной файл сервера с WebSocket endpoints
│   ├── game_logic.py # Логика шахматной игры
│   ├── rating.py     # Система рейтинга Elo
│   ├── database.py   # Модель базы данных SQLite
│   ├── auth.py       # Система аутентификации
│   ├── schemas.py    # Pydantic схемы для валидации
│   └── logger.py     # Система логирования
├── shared/           # Общий код для обеих версий
│   ├── chess_engine.py # Общий шахматный движок
│   ├── exceptions.py  # Кастомные исключения
│   └── constants.py  # Общие константы
└── frontend/         # Frontend приложение
```

### Основные компоненты

#### Backend (FastAPI)
- **main.py**: WebSocket сервер для реального времени, управление комнатами, matchmaking
- **game_logic.py**: Логика шахматной игры (использует общий движок из shared/)
- **database.py**: Работа с SQLite (игроки, рейтинги, история игр)
- **rating.py**: Система рейтинга Elo с персистентным хранением
- **schemas.py**: Валидация всех WebSocket сообщений через Pydantic
- **auth.py**: Базовая система аутентификации с токенами

#### Shared модули
- **chess_engine.py**: Общий шахматный движок с оптимизированной проверкой шаха
- **exceptions.py**: Кастомные исключения для обработки ошибок
- **constants.py**: Централизованные константы

### API Endpoints

#### WebSocket
- `/ws/{room_id}/{player_id}` - Подключение к игровой комнате
- `/ws/matchmaking/{player_id}` - Поиск соперника

#### HTTP
- `/` - Главная страница (frontend/index.html)
- `/v2.5`, `/v2.6`, `/v2.7` - Различные версии frontend

### Типы WebSocket сообщений

Все сообщения валидируются через Pydantic схемы:
- `move` - Выполнение хода
- `get_valid_moves` - Получение допустимых ходов
- `resign` - Сдача
- `offer_draw` - Предложение ничьей
- `request_undo` - Запрос отмены хода
- `get_rating` - Получение рейтинга
- И другие...

## Локальный запуск

### С Python
```bash
cd backend
pip install -r requirements.txt
uvicorn main:app --host 0.0.0.0 --port 8000
```
Откройте http://localhost:8000

### С Docker
```bash
docker-compose up --build
```

## Тестирование

```bash
# Тесты шахматного движка
cd shared/tests
pytest test_chess_engine.py -v

# Тесты рейтинговой системы
cd backend/tests
pytest test_rating.py -v
```

## База данных

Используется SQLite для хранения:
- **players**: Игроки и их рейтинги
- **rating_history**: История изменения рейтингов
- **games**: Завершенные игры

База данных автоматически инициализируется при первом запуске.

## Логирование

Логи сохраняются в директории `logs/`:
- `chess_online.log` - Основной лог с ротацией (10 MB, 5 файлов)

## Безопасность

- Валидация всех WebSocket сообщений через Pydantic
- Базовая система аутентификации с токенами
- Rate limiting для предотвращения спама
- Санитизация входных данных

## Производительность

- Оптимизированная проверка шаха с кэшированием атакованных клеток
- Эффективный matchmaking с приоритетной очередью
- Асинхронная работа с базой данных (aiosqlite)

## Деплой на Timeweb Cloud

### 1. Создание приложения
1. Войдите в панель Timeweb Cloud
2. Создайте новое приложение (App Platform или Docker)
3. Подключите репозиторий или загрузите файлы

### 2. Настройка
- Порт: 8000
- Команда запуска: `uvicorn backend.main:app --host 0.0.0.0 --port 8000`

### 3. Переменные окружения (опционально)
- `PORT` - порт приложения (по умолчанию 8000)

## Как играть
1. Откройте приложение в браузере
2. Введите ID комнаты или нажмите "Новая игра"
3. Отправьте ID комнаты другу
4. Играйте!

## Технологии
- Backend: FastAPI + WebSockets + SQLite
- Frontend: HTML5 Canvas + JavaScript
- Валидация: Pydantic
- Тестирование: pytest
- Деплой: Docker

